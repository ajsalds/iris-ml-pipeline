name: CD to GKE

on:
  push:
    branches:
      - feature/cd-gke-iris  # or restrict to release tags
  workflow_dispatch:

env:
  IMAGE_NAME: iris-api
  IMAGE_TAG: ${{ github.sha }}
  REGION: us-central1   # set your region
  REPOSITORY: ml-repo # artifact registry repo name
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  CLUSTER_NAME: iris-cluster-gke
  CLUSTER_LOCATION: us-central1  # zone or region depending on cluster

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Cloud auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}

      - name: Configure gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          install_components: gke-gcloud-auth-plugin

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud --project=${{ env.PROJECT_ID }} auth configure-docker ${REGION}-docker.pkg.dev --quiet

      - name: Build and push image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ env.CLUSTER_NAME }}
          location: ${{ env.CLUSTER_LOCATION }}
          project_id: ${{ env.PROJECT_ID }}

      - name: Update k8s manifests image
        run: |
          # replace placeholder image in k8s/deployment.yaml and apply
          IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          kubectl set image deployment/iris-api iris-api=$IMAGE --record || kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/iris-api --timeout=120s

      - name: Show service endpoint
        run: kubectl get svc iris-api-lb -o wide
