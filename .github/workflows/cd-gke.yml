name: CD to GKE (Iris API)

on:
  push:
    branches:
      - feature/k8s-autoscaling-loadtest
  workflow_dispatch:

env:
  IMAGE_NAME: iris-api
  IMAGE_TAG: ${{ github.sha }}
  REGION: us-central1
  REPOSITORY: ml-repo
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  CLUSTER_NAME: iris-gke-cluster
  CLUSTER_LOCATION: us-central1-a
  DEPLOYMENT_NAME: iris-api
  SERVICE_NAME: iris-api-lb

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Google Cloud authentication
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}

      - name: Configure gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          install_components: gke-gcloud-auth-plugin

      - name: Pull model/data from DVC (Google Cloud Storage)
        run: |
          pip install dvc[gs]
          dvc pull -v

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud --project=${{ env.PROJECT_ID }} auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          no-cache: true
          tags: |
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ env.CLUSTER_NAME }}
          location: ${{ env.CLUSTER_LOCATION }}
          project_id: ${{ env.PROJECT_ID }}

      - name: Update Kubernetes manifests and deploy
        run: |
          IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          sed -i "s|PLACEHOLDER_IMAGE|$IMAGE|g" k8s/deployment.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl apply -f k8s/hpa.yaml

      - name: Wait for rollout
        run: kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} --timeout=180s

      - name: Show service endpoint
        run: kubectl get svc ${{ env.SERVICE_NAME }} -o wide

      - name: Stress test API (CML)
        uses: iterative/setup-cml@v2

      - name: Run wrk load test
        run: |
          ENDPOINT=$(kubectl get svc ${{ env.SERVICE_NAME }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          echo "Testing endpoint: http://$ENDPOINT/predict"

          # Install wrk
          sudo apt-get install -y wrk

          # Run load test
          wrk -t4 -c2000 -d180s --latency -s post.lua http://$ENDPOINT/predict > wrk_result.txt

      - name: Report results with CML
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## Stress Test Results" > report.md
          echo "\`\`\`" >> report.md
          cat wrk_result.txt >> report.md
          echo "\`\`\`" >> report.md
          cml comment create --publish report.md
